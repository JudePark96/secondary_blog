---
layout: post
title: "SQL Tuning - 1"
date: 2018-11-25
tags: [SQL]
excerpt: "친절한 SQL 튜닝 1장"
comments: true
---

### 0. SQL 파싱과 최적화

#### SQL 최적화란? 

- DBMS 내부에서 프로시저를 작성하고 컴파일해서 실행 가능한 상태로 만드는 전 과정을 SQL 최적화라고 한다.

#### SQL 최적화의 세분화

- SQL 파싱
  - 파싱 트리 생성
  - 문법 체크
  - 의미 체크
- SQL 최적화
  - 미리 수집한 시스템 및 오브젝트 통계 정보를 바탕으로 다양한 실행 경로를 생성하여 비교, 가장 효율적인 하나를 선택한다.
    - Decision Tree
- 로우 소스 생성
  - 실행 가능한 코드 및 프로시저 형태로 포맷팅한다.

#### SQL 옵티마이저

- 사용자로부터 전달받은 쿼리를 수행하는데 후보군이 될만한 실행계획을 찾아낸다.
- 데이터 딕셔너리에 미리 수집해둔 오브젝트 통계 및 시스템 통계 정보를 이용하여 각 실행 계획의 예상 비용을 산정한다.
- 최저 비용을 나타내는 실행 계획을 선택한다.

자동차 내비게이션과 비슷한 원리로 Decision Tree 를 통하여 Cost 를 계산하고 가장 적은 Cost 의 후보군을 선택한다.

> MySQL 에서 Explain 을 사용하면 해당 쿼리의 실행 계획을 볼 수 있다.



### 1. SQL 공유 및 재사용

라이브러리 캐시

- 내부 프로시저를 반복 재사용할 수 있도록 캐싱해 두는 메모리 공간
- SGA (System Global Area) 의 구성요소이다.
- DBMS 에 SQL 을 파싱한 후, 해당 SQL 이 라이브러리 캐시에 존재하는지 확인한다.
  - 캐시에서 찾으면 곧바로 실행단계로 넘어간다.
    - 이를 **소프트 파싱**이라 하며, 이의 반대는 **하드 파싱**이라 한다.

SGA (Service Global Area)

- 서버 프로세스와 백그라운드 프로세스가 공통으로 액세스하는 데이터와 제어 구조를 캐싱하는 메모리 공간.

SQL 옵티마이저가 사용하는 정보

- 테이블, 칼럼, 인덱스 구조에 관한 기본 정보
- 오브젝트 통계 : 테이블, 인덱스, 칼럼 통계
- 시스템 통계: CPU 속도, Single Block I/O 속도, Multiblock I/O 속도
- 옵티마이저 관련 파라미터

대부분의 처리 과정은 I/O 작업에 집중되지만 하드 파싱은 CPU 를 많이 소비하는 몇 안되는 작업 중 하나다. 이러한 과정을 거쳐 생성한 내부 프로시저를 한 번만 사용하고 버린다면 비효율적이며 그렇기 때문에 라이브러리 캐시가 필요하다.

#### 바인딩 변수의 중요성

SQL 은 따로 이름이 없으며 SQL 문 자체가 Key 로서 생성되어 캐시에 적재된다. 예를 들면 다음과 같다.

`select * from emp where empno = 79000;` 과 `select * from emp WHERE empno = 79000;` 의 의미적 관점에서 바라보면 똑같은 쿼리이지만, 캐시에는 각각의 SQL 문으로서 적재되는 것이다.

동시다발적으로 이러한 쿼리가 들어온다면 CPU 사용률이 급격히 올라가고, 라이브러리 캐시에 발생하는 여러 종류의 경합 때문에 쿼리가 제대로 처리되지 않을 것이다.

그렇기 때문에 **Parameter-Driven** 으로 쿼리를 작성하는 방법이 제안되는데 바인드 변수가 바로 그렇다.

`SELECT * FROM CUSTOMER WHERE LOGIN_ID = ?` 식으로 한다면 라이브러리 캐시를 조회한다면 하나의 쿼리만 볼 수 있을 것이다.